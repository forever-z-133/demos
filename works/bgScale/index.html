<!DOCTYPE html>
<html class="mobile">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html" />
<meta name="viewport" content="width=750,user-scalable=no" />
<meta name="renderer" content="webkit">
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<title>(仿)娱乐圈画卷一镜到底</title>
<!--[if lt IE 9]><script>alert('您的浏览器版本过低，请更新本版本浏览器，或更换为诸如谷歌浏览器的现代浏览器')</script><![endif]-->
<link rel="stylesheet" href="style.css">
</head>

<body>
<!-- <div class="rotate-info" id="info">请保持竖屏浏览</div> -->
<div class="body" id="main">
    <div class="main-load" id="main-load">
        <div class="load-img"><div class="icon-music on"></div></div>
        <div class="load-text"><span id="load-text">0</span>% 加载中</div>
    </div>
    <div class="page welcome" id="welcome">
        <canvas id="game" class="bg"></canvas>
        <div class="buttons">
            <a href="#" class="btn" id="start">按住播放</a>
            <!-- <button id="stop">暂停</button> -->
        </div>
    </div>
<!--    <div class="page gallery" id="gallery">
        <div id="pic1"><img src="img/1.jpg"></div>
        <div id="pic2"><img src="img/2.jpg"></div>
        <div id="pic3"><img src="img/3.jpg"></div>
        <div id="pic4"><img src="img/4.jpg"></div>
        <div id="pic5"><img src="img/5.jpg"></div>
        <div id="pic6"><img src="img/6.jpg"></div>
        <div id="pic7"><img src="img/6_5.jpg"></div>
        <div id="pic8"><img src="img/7.jpg"></div>
        <div id="pic9"><img src="img/7_5.jpg"></div>
        <div id="pic10"><img src="img/8.jpg"></div>
        <div id="pic11"><img src="img/8_5.jpg"></div>
        <div id="pic12"><img src="img/9.jpg"></div>
        <div id="pic13"><img src="img/9_5.jpg"></div>
        <div id="pic14"><img src="img/10.jpg"></div>
        <div id="pic15"><img src="img/10_5.jpg"></div>
        <div id="pic16"><img src="img/11.jpg"></div>
        <div id="pic17"><img src="img/11_5.jpg"></div>
        <div id="pic18"><img src="img/12.jpg"></div>
        <div id="pic19"><img src="img/12_5.jpg"></div>
        <div id="pic20"><img src="img/13.jpg"></div>
        <div id="pic21"><img src="img/13_5.jpg"></div>
        <div id="pic22"><img src="img/14.jpg"></div>
        <div id="pic23"><img src="img/15.jpg"></div>
    </div> -->
</div>
<script src="https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script>

var imgList = [{
    link: "img/1.jpg",
    imgW: "750",
    imgH: "1206"
}, {
    link: "img/2.jpg",
    limitMax: .3,
    limitMin: .2,
    imgW: "1875",
    imgH: "3015",
    areaW: "375",
    areaH: "603",
    areaL: "1379",
    areaT: "103",
}, {
    link: "img/3.jpg",
    limitMax: .12,
    limitMin: .08,
    imgW: "1875",
    imgH: "3015",
    areaW: "152",
    areaH: "244",
    areaL: "791",
    areaT: "1193"
}, {
    link: "img/4.jpg",
    limitMax: .22,
    limitMin: .15,
    imgW: "1875",
    imgH: "3015",
    areaW: "282",
    areaH: "454",
    areaL: "857",
    areaT: "413"
}, {
    link: "img/5.jpg",
    limitMax: .18,
    limitMin: .123,
    imgW: "1875",
    imgH: "3015",
    areaW: "232",
    areaH: "372",
    areaL: "388",
    areaT: "844"
}, {
    link: "img/6.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "187",
    areaH: "300",
    areaL: "359",
    areaT: "1226"
}, {
    link: "img/6_5.jpg",
    limitMax: .6,
    limitMin: .415,
    imgW: "1875",
    imgH: "3015",
    areaW: "778",
    areaH: "1251",
    areaL: "133",
    areaT: "856"
}, {
    link: "img/7.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "278",
    areaH: "446",
    areaL: "794",
    areaT: "783"
}, {
    link: "img/7_5.jpg",
    limitMax: .75,
    limitMin: .5,
    imgW: "1875",
    imgH: "3015",
    areaW: "938",
    areaH: "1507",
    areaL: "428",
    areaT: "454"
}, {
    link: "img/8.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "290",
    areaH: "466",
    areaL: "1276",
    areaT: "665"
}, {
    link: "img/8_5.jpg",
    limitMax: .6,
    limitMin: .415,
    imgW: "1875",
    imgH: "3015",
    areaW: "782",
    areaH: "1258",
    areaL: "977",
    areaT: "557"
}, {
    link: "img/9.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "238",
    areaH: "382",
    areaL: "1206",
    areaT: "2310"
}, {
    link: "img/9_5.jpg",
    limitMax: .47,
    limitMin: .355,
    imgW: "1875",
    imgH: "3015",
    areaW: "669",
    areaH: "1076",
    areaL: "894",
    areaT: "1608"
}, {
    link: "img/10.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "247",
    areaH: "396",
    areaL: "285",
    areaT: "45"
}, {
    link: "img/10_5.jpg",
    limitMax: .75,
    limitMin: .5,
    imgW: "1875",
    imgH: "3015",
    areaW: "938",
    areaH: "1507",
    areaL: "264",
    areaT: "21"
}, {
    link: "img/11.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "434",
    areaH: "698",
    areaL: "1059",
    areaT: "192"
}, {
    link: "img/11_5.jpg",
    limitMax: .6,
    limitMin: .415,
    imgW: "1875",
    imgH: "3015",
    areaW: "780",
    areaH: "1256",
    areaL: "1038",
    areaT: "679"
}, {
    link: "img/12.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "415",
    areaH: "668",
    areaL: "226",
    areaT: "2210"
}, {
    link: "img/12_5.jpg",
    limitMax: .6,
    limitMin: .415,
    imgW: "1875",
    imgH: "3015",
    areaW: "782",
    areaH: "1258",
    areaL: "356",
    areaT: "1652"
}, {
    link: "img/13.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "288",
    areaH: "462",
    areaL: "1494",
    areaT: "528"
}, {
    link: "img/13_5.jpg",
    limitMax: .6,
    limitMin: .415,
    imgW: "1875",
    imgH: "3015",
    areaW: "782",
    areaH: "1257",
    areaL: "1017",
    areaT: "482"
}, {
    link: "img/14.jpg",
    imgW: "1875",
    imgH: "3015",
    areaW: "99",
    areaH: "160",
    areaL: "1158",
    areaT: "2312"
}, {
    link: "img/15.jpg",
    limitMax: .1,
    limitMin: .053,
    imgW: "1875",
    imgH: "3015",
    areaW: "469",
    areaH: "753",
    areaL: "1001",
    areaT: "2034 "
}];

$(function(){
    var $text = $('#load-text');
    preload(imgList, function(per){
        console.log(per);
        $text.text(parseInt(per));
    },function(list){
        $('#main-load').fadeOut('fast');
        $('#welcome').fadeIn(0, function(){
            Game(list, function(){
                alert('放完了！');
            });
        });
    });
});

// 预加载，不加载完 drawImage 会出问题
function preload(list, fn,callback) {
    for (var i=0,len=list.length; i<len; i++) {
        list[i].dom = new Image();
        list[i].dom.index = i;
        list[i].dom.onload = function(){
            fn && fn(this.index/len*100);
            if (this.index >= len - 1) {
                fn && fn(99);
                callback && callback(list);
            }
        };
        list[i].dom.src = list[i].link;
    }
}

function Game(list, finish) {
    // 初始化 canvas
    var canvas = $('#game')[0];
    var ctx = canvas.getContext('2d');
    var W = canvas.width = window.innerWidth;
    var H = canvas.height = window.innerHeight;
    $(window).off('.game').on('resize', function(){
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
        draw();
    });

    // 其他参数
    var timer = null;   // 动画计时器
    var index = 0;      // 当前显示的是哪一页
    var len = list.length;
    var opt = {
        radio: 1,       // 
        fps: 40,        // 帧率，无用
        scale: .97,    // 普通速度，越小越快
        scaleSlow: .98,// 缓视速度，就是到重点地方了会放慢一点
        // 测试用
        // scale: .8,
        // scaleSlow: .81,
    }

    // 启动
    draw();
    // start();
    function start() {
        cancelAnimationFrame(timer);
        timer = requestAnimationFrame(loop);
    }

    function stop() {
        cancelAnimationFrame(timer);
    }

    // 循环
    var t = (new Date).getTime();
    function loop() {
        var a = (new Date).getTime();
        // console.log(index, len)
        if (index + 1 != len) {
            // 播放太快中间空白期用另一个 loop 补上
            if (a - t < 1e3 / opt.fps) return void(timer = requestAnimationFrame(loop));
            // 判断速率，在 limitMin 和 limitMax 区间内使用 scaleSlow 速率，否则用 scale 普通速率
            var limitMin = list[index+1].limitMin, limitMax = list[index+1].limitMax;
            if (limitMin && limitMax && opt.radio < limitMax && opt.radio > limitMin) {
                opt.radio = opt.scaleSlow * opt.radio
            } else {
                opt.radio = opt.scale * opt.radio
            }
            // 绘制
            draw();
            // 循环
            timer = requestAnimationFrame(loop)
            t = a;
        }
    }

    // 绘制
    function draw() {
        if (index + 1 == len) return;
        // 当后一张图可视区域进入视野，则将 index 换成后图，速率还原
        if (opt.radio <= list[index+1].areaW / list[index+1].imgW) {
            index++;
            opt.radio = 1;
            if (!list[index+1]) return void finish();
        }
        // 绘制两张图
        var imgNext = list[index+1], imgCur = list[index];
        drawImgOversize(imgNext.dom, imgNext.imgW, imgNext.imgH, imgNext.areaW, imgNext.areaH, imgNext.areaL, imgNext.areaT, opt.radio);
        drawImgMinisize(imgCur.dom, imgCur.imgW, imgCur.imgH, imgNext.imgW, imgNext.imgH, imgNext.areaW, imgNext.areaH, imgNext.areaL, imgNext.areaT, opt.radio);
    }

    // 后一张图，
    function drawImgOversize(img, e, t, a, n, m, s, g) {
        ctx.drawImage(img, m - (a / g - a) * (m / (e - a)), s - (n / g - n) * (s / (t - n)), a / g, n / g, 0, 0, W, H)
    }
    // 当前图，
    function drawImgMinisize(img, e, t, a, n, m, s, g, r, o) {
        ctx.drawImage(img, 0, 0, e, t, (m / o - m) * (g / (a - m)) * o * W / m, (s / o - s) * (r / (n - s)) * o * H / s, W * o, H * o)
    }

    // $('#start').on('click', start);
    // $('#stop').on('click', stop);
    
    $('#start').on('mousedown.map touchstart.map', function(e){
        e.preventDefault();
        start();
        $(window).off('.xx').on('mouseup.map touchend.map', function(){
            stop();
        });
    });
}


function pageShow(page, callback) {
    var $page = $(page).fadeIn(function(){
        callback && callback();
    });
    $page.siblings('.page').fadeOut('fast');
    $page.siblings('.modal').removeClass('open');
    return $page;
}
</script>
</body>
</html>