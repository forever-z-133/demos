<!DOCTYPE html>
<html class="mobile h5">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <title>“伊”声祝福，我来传达！</title>
    <!--[if lt IE 9]><script>alert('您的浏览器版本过低，请更新本版本浏览器，或更换为诸如谷歌浏览器的现代浏览器')</script><![endif]-->
    <link rel="stylesheet" href="libs/style.css">
    <style>
        body, .body, .page {
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="rotate-info hide" id="rotate-info">请保持竖屏或手机浏览本页</div>
    <div class="body" id="main">
        <!-- 加载页 -->
        <div class="main-load" id="main-load">
            <div class="load-img"><img src="img/icon.jpg"></div>
            <div class="load-text"><span id="load-text">0</span> % 加载中</div>
        </div>
        <!-- 背景页 -->
        <div class="page main-bg" id="main-bg">
            <div class="bg"><img src="img/main.jpg"></div>
        </div>
        <!-- 首页 -->
        <div class="page welcome" id="welcome">
            <div class="city"><img src="img/city.png"></div>
            <div class="title"><img src="img/title.png" class="hide"></div>
            <div class="people hide"><img src="img/people.png"></div>
            <a href="#" class="btn btn-rule hide" id="btn-rule"><img src="img/btn-rule.png"></a>
            <div class="buttons hide">
                <a href="#" class="btn btn-start" id="btn-start"><img src="img/btn-start.png"></a>
                <a href="#" class="btn btn-my disabled" id="btn-my"><img src="img/btn-my.png"></a>
            </div>
        </div>
        <!-- 制作页 -->
        <div class="page make" id="make">
            <a href="#" class="btn btn-back hide" id="btn-back1"><img src="img/btn-back.png"></a>
            <div class="cards swiper-container hide">
                <div class="swiper-wrapper">
                    <div class="card-wrapper card1 swiper-slide">
                        <div class="card">
                            <img src="img/user.png" class="user-head">
                            <img src="img/card1.png" class="card-bg">
                            <textarea class="input"></textarea>
                        </div>
                    </div>
                    <div class="card-wrapper card2 swiper-slide">
                        <div class="card">
                            <img src="img/user.png" class="user-head">
                            <img src="img/card2.png" class="card-bg">
                            <textarea class="input"></textarea>
                        </div>
                    </div>
                    <div class="card-wrapper card3 swiper-slide">
                        <div class="card">
                            <img src="img/user.png" class="user-head">
                            <img src="img/card3.png" class="card-bg">
                            <textarea class="input"></textarea>
                        </div>
                    </div>
                </div>
                <div class="btn-prev"><img src="img/btn-arrow.png"></div>
                <div class="btn-next"><img src="img/btn-arrow.png"></div>
            </div>
            <div class="buttons hide">
                <a href="#" class="btn btn-share" id="btn-share1"><img src="img/btn-send.png"></a>
                <a href="#" class="btn btn-save" id="btn-save"><img src="img/btn-save.png"></a>
            </div>
        </div>
        <!-- 列表页 -->
        <div class="page preview" id="list">
            <a href="#" class="btn btn-back hide" id="btn-back2"><img src="img/btn-back.png"></a>
            <div class="list-wrapper hide">
                <img src="img/mail-bg.png" class="bg">
                <div class="list-box">
                    <ul class="list cover canScroll"></ul>
                </div>
            </div>
        </div>
        <!-- 详情页 -->
        <div class="page my" id="my">
            <a href="#" class="btn btn-back hide" id="btn-back3"><img src="img/btn-back.png"></a>
            <a href="#" class="btn btn-police hide" id="btn-police"><img src="img/btn-police.png"></a>
            <div class="card-wrapper card3 hide">
                <div class="card">
                    <img src="img/user.png" class="user-head">
                    <img src="img/card3.png" class="card-bg" id="user-card">
                    <textarea class="input disabled" id="user-content" readonly></textarea>
                </div>
            </div>
            <div class="buttons hide">
                <a href="#" class="btn btn-share" id="btn-share2"><img src="img/btn-send.png"></a>
            </div>
        </div>
        <!-- 投诉成功 -->
        <div class="page police" id="police">
            <div class="bg"><img src="img/main.jpg"></div>
            <a href="#" class="btn btn-back"><img src="img/btn-back.png"></a>
            <div class="police-tip"><img src="img/word-ok.png"></div>
        </div>
        <!-- 提示 -->
        <div class="tips bottom" id="tips"></div>
        <div class="toast load" id="load"><div class="toast-wrap"></div></div>
        <!-- 背景音乐 -->
        <div class="others">
            <a href="#" class="btn btn-music"><div class="icon-music"></div></a>
            <audio src="img/bgm.mp3" id="bgm" preload autoplay hidden loop></audio>
        </div>
        <!-- logo -->
        <div class="logo"><img src="img/logo.png"></div>
    </div>
    <!-- 规则弹窗 -->
    <div class="modal" id="rule">
        <div class="bg modal-bg"></div>
        <div class="modal-box cover">
            <div class="rule">
                <img src="img/rule.png">
                <a href="#" class="btn btn-close"><img src="img/btn-close.png"></a>
            </div>
        </div>
    </div>
    <!-- 分享页 -->
    <div class="modal" id="share">
        <div class="bg modal-bg"></div>
        <div class="modal-box share"><img src="img/share.png"></div>
    </div>

    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="http://cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/Swiper/3.4.2/js/swiper.min.js"></script>
    <!-- <script src="http://htmlcase.kdcer.com/Scripts/Statistics.js"></script> -->
    <script src="libs/common.js"></script>
    <!--<script src="libs/statistics.js"></script>-->
    <script>
        // 其他标量
        var $tips = $('#tips');
        var $load = $('#load');
        var nowID = 0;
        var master = true;

        // 微信分享
        WeChat('“伊”声祝福，我来传达！', '点击“大声说出你的爱！”写下你最想对妈妈说的话', 'http://sum.kdcer.com/MotherDay/img/icon.jpg', 'http://sum.kdcer.com/Event?EventId=34');
        // 强刷新页面
        var link = new Link('');
        // 统计
        // window.sessionStorage.removeItem("event");
        // $("body").Record({
        //     params: { CaseGuid: "8843df83e2d9429296cf288da1422d00" },
        //     MaskEvent: [
        //         { IdName: "btn-start", EventType: "click", Detail: "开始制作" },
        //         { IdName: "btn-my", EventType: "click", Detail: "查看我的贺卡" },
        //         { IdName: "btn-back2", EventType: "click", Detail: "我的贺卡返回首页" },
        //         { IdName: "btn-share1", EventType: "click", Detail: "在制作时转发" },
        //         { IdName: "btn-back1", EventType: "click", Detail: "制作业返回首页" },
        //         { IdName: "btn-share2", EventType: "click", Detail: "制作完成的详情页点击转发" },
        //         { IdName: "btn-save", EventType: "click", Detail: "制作完成保存" },
        //         { IdName: "btn-back3", EventType: "click", Detail: "从贺卡详情页面返回" },
        //         { IdName: "btn-rule", EventType: "click", Detail: "查看规则" },
        //     ]
        // });

        // 路由
        //router.route('/', Welcome);
        router.route('welcome', Welcome);
        router.route('make', Make);
        router.route('list', List);
        router.route('my', My);
        router.route('police', Police);

        // 图片预加载
        var imgArr = ['img/icon.jpg', 'img/btn-arrow.png', 'img/btn-back.png', 'img/btn-close.png', 'img/btn-happy.png', 'img/btn-my.png', 'img/btn-police.png', 'img/btn-rule.png', 'img/btn-save.png', 'img/btn-send.png', 'img/btn-share.png', 'img/btn-start.png', 'img/btn-view.png', 'img/card1.png', 'img/card2.png', 'img/card3.png', 'img/city.png', 'img/logo.png', 'img/mail-bg.png', 'img/main.jpg', 'img/people.png', 'img/rule.png', 'img/share.png', 'img/title.png', 'img/word-ok.png'];
        var $load_text = $('.load-text span');
        preloadImage(imgArr, function (per) {
            $load_text.text(parseInt(per));
        }, function () {
            $('#main-load').fadeOut('fast');
            $('#main-bg').fadeIn();
            if (!window.location.hash) history.replaceState({}, '', '#welcome');
        });

        // 入口判断与赋值
        // $.post('/Event/MontherEnter', {
        //     EventId: 34,
        // }, function (r) {
        //     console.log(r);
        //     if (!r.State) {
        //         r.ErrorMessage && alert(r.ErrorMessage);
        //     } else {   // 合法
        //         if (r.list && r.list.length > 0) {  // 发起者
        //             $('.btn-my').enable();
        //             $('.user-head').attr('src', r.OwnUrl || 'img/img/user.png');
        //             var _html = '';
        //             for (var i = 0, len = r.list.length; i < len; i++) {
        //                 var one = r.list[i];
        //                 if (!one.Vaild) continue;
        //                 _html += Item(one.Id, one.Detail, one.Type);
        //             }
        //             $('#list .list').empty().append(_html);
        //             Welcome();
        //             //window.history.replaceState({}, '', '#welcome');
        //         } else if (r.detail) {      // 接收者
        //             nowID = r.detail.Id;
        //             master = false;
        //             $('#user-content').val(r.detail.Detail);
        //             $('#my .card-wrapper').removeClass('card1 card2 card3').addClass('card' + r.detail.Type);
        //             $('#user-card').attr('src', 'img/card' + r.detail.Type + '.png');
        //             $('.user-head').attr('src', r.detail.HeadUrl || 'img/user.png');
        //             //window.history.replaceState({}, '', '#my');
        //             //window.location.hash = 'my';
        //             My();
        //         } else {        // 最初形态
        //             $('.btn-my').disable();
        //             $('.user-head').attr('src', r.OwnUrl || 'img/user.png');
        //             Welcome();
        //         }
        //     }
        // }).fail(function (err) {
        //     alert('程序出了点小问题，请稍后再访问。');
        // });

        // ----------- 公共事件
        // 分享/关闭分享
        $('body').on('click', '.btn-share', function () {
            $('#share').addClass('in');
        });
        $('#share').on('click', function () {
            $(this).removeClass('in');
        });
        // 返回按钮
        $('body').on('click', '.btn-back', function () {
            $(this).parents('.page').fadeOut('fast');
            window.history.back();
        });


        // ----------- 首页页事件
        // 跳往制作页
        $('.btn-start').on('click', function () {
            $('#welcome').fadeOut('fast');
            $('.input').val('');
            window.location.hash = 'make';
        });
        // 跳往列表页
        $('.btn-my').on('click', function () {
            $('#welcome').fadeOut('fast');
            window.location.hash = 'list';
        });
        // 规则弹窗/关闭规则
        $('.btn-rule').on('click', function () {
            $('#rule').addClass('in');
        });
        $('.btn-close').on('click', function () {
            $('#rule').removeClass('in');
        });

        // ----------- 制作页事件
        // 输入文字
        var LastText = '';
        $('.input').on('input keypress', function (e) {
            //e.preventDefault();
            var $this = $(this);
            var val = $this.val();
            // 限制不得超过文本域高度
            //console.log($this[0].scrollHeight, $this[0].offsetHeight)
            if ($this[0].scrollHeight > $this[0].offsetHeight) {
                val = LastText;
            }
            LastText = val;
            //console.log(LastText)
            $('.input').not(this).val(LastText);
        });
        // 保存
        $('.btn-save').on('click', function () {
            // 判断是否为空
            var val = $('.input').val();
            if (val == '') { alert('写几句吧，么么哒！'); return; }
            // 改变详情页背景图
            var index = parseInt($('.swiper-slide-active').attr('data-swiper-slide-index')) + 1;
            $('#my .card-wrapper').removeClass('card1 card2 card3').addClass('card' + index);
            $('#my .card-bg').attr('src', 'img/card' + index + '.png');
            console.log(val, index);
            // 保存到后台
            $load.addClass('in');
            // $.post('/Event/MontherSendDetail', {
            //     EventId: 34,
            //     detail: val,
            //     type: index,
            // }, function (r) {
            //     console.log(r);
            //     $load.removeClass('in');
            //     if (r.State) {
            //         nowID = r.Shsare.Id;
            //         $('#make').fadeOut('fast');
            //         $('#list .list').append(Item(nowID, val, index));
            //         window.location.hash = 'my';
            //     } else {
            //         r.ErrorMessage ? alert(r.ErrorMessage) : alert('未成功保存，请稍后重新尝试');
            //     }
            // }).fail(function () {
            //     alert('请求出错...');
            // });

            $load.removeClass('in');
            nowID = 0;
            $('#make').fadeOut('fast');
            $('#list .list').append(Item(nowID, val, index));
            $('.btn-my').enable();
            window.location.hash = 'my';
        });
        // 送祝福 = 分享按钮

        // ----------- 详情页事件
        // 投诉
        $('.btn-police').on('click', function () {
            $load.addClass('in');
            // $.post('/Event/MontherErrorDetail', {
            //     EventId: 34,
            //     Id: nowID,
            // }, function (r) {
            //     console.log(r);
            //     $load.removeClass('in');
            //     if (r.State) {
            //         $('#my').fadeOut('fast');
            //         Police();
            //         window.location.hash = 'police';
            //     } else {
            //         r.ErrorMessage && alert(r.ErrorMessage);
            //     }
            // }).fail(function () {
            //     alert('请求出错...');
            // });

            Police();
            window.location.hash = 'police';
        });

        // ----------- 列表页事件
        $('body').on('click', '.btn-view', function () {
            var $this = $(this).parents('.item');
            var val = $this.find('.content').text();
            $('.input').val(val);
            var i = parseInt($this.attr('data-type'));
            $('#my .card-wrapper').removeClass('card1 card2 card3').addClass('card' + i);
            $('#my .card-bg').attr('src', 'img/card' + i + '.png');
            nowID = $this.attr('data-id');
            $('#list').fadeOut('fast');
            window.location.hash = 'my';
        });

        // 欢迎页面
        function Welcome() {
            $('#make, #list').fadeOut('fast');
            $('#welcome').fadeIn(function () {
                $('.title img').addAnim('anim-title', function () {
                    $(this).addClass('hide').addAnim('anim-title2');
                    $('.people').addAnim('anim-people1', function () {
                        $('#welcome .buttons, .btn-rule').addAnim('anim-fade');
                    });
                });
            });
        }

        // 制作页
        var swiper = null;  // 轮播函数
        function Make() {
            WeChat('“伊”声祝福，我来传达！', '点击“大声说出你的爱！”写下你最想对妈妈说的话', 'http://sum.kdcer.com/MotherDay/img/icon.jpg', 'http://sum.kdcer.com/Event?EventId=34');
            $('#my').fadeOut('fast');
            $('#make').fadeIn(function () {
                var $this = $(this);
                $('.cards').addAnim('anim-cards', function () {
                    $this.find('.buttons, .btn-back').addAnim('anim-fade');
                    if (!swiper) {
                        swiper = new Swiper('.cards', {
                            loop: true,
                            prevButton: '.btn-prev',
                            nextButton: '.btn-next',
                        });
                    }
                });
            });
        }

        // 列表页
        function List() {
            WeChat('“伊”声祝福，我来传达！', '点击“大声说出你的爱！”写下你最想对妈妈说的话', 'http://sum.kdcer.com/MotherDay/img/icon.jpg', 'http://sum.kdcer.com/Event?EventId=34');
            $('#my').fadeOut('fast');
            $('#list').fadeIn(function () {
                var $this = $(this);
                $this.find('.list-wrapper').addAnim('anim-list', function () {
                    $this.find('.btn-back').addAnim('anim-fade');
                });
            });
        }

        // 我的页
        function My() {
            var href = 'http://sum.kdcer.com/Event?EventId=34&shareCustomer=' + nowID;
            WeChat('“伊”声祝福，我来传达！', '点击“大声说出你的爱！”写下你最想对妈妈说的话', 'http://sum.kdcer.com/MotherDay/img/icon.jpg', href);
            $('#welcome, #police').fadeOut('fast');
            $('#my .card-wrapper').addClass('hide');
            $('#my').fadeIn(function () {
                var $this = $(this);
                $this.find('.card-wrapper').addAnim('anim-card', function () {
                    $this.find('.buttons').addAnim('anim-fade');
                });
                if (!master) {  // 如果是接收者，才有投诉，返回为返回首页
                    $this.find('.btn-back').addAnim('anim-fade');
                    $(window).off(); $('body').off(); $('.btn-back').off(); $('#my').off();
                    $('.btn-back').off().on('click', function () {
                        //window.history.replaceState({}, '', 'http://sum.kdcer.com/Event?EventId=34');
                        var temp = Math.random().toString(36).substring(2, 7)
                        window.location.href = 'http://sum.kdcer.com/Event?EventId=34&temp=' + temp;
                        //window.location.replace('/Event?EventId=34');
                    });
                    $this.find('.btn-police').addAnim('anim-fade');
                } else {
                    $this.find('.btn-back').addAnim('anim-fade');
                }
            });
        }

        // 投诉成功
        function Police() {
            $('#police').fadeIn();
        }

        function Item(id, content, type, vaild) {
            var _html = '';
            _html += '<li class="item" data-type="' + (type || 1) + '" data-id="' + id + '">';
            //content = content && content.replace('<', '')
            _html += '<div class="content">' + (content || '') + '</div>';
            _html += '<footer class="item-foot">';
            _html += '<a href="#" class="btn btn-share"><img src="img/btn-share.png"></a>';
            _html += '<a href="#" class="btn btn-view"><img src="img/btn-view.png"></a>';
            _html += '</footer>';
            _html += '</li>';
            return _html;
        }
    </script>
</body>
</html>